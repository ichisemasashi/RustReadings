# å†…éƒ¨å¯å¤‰æ€§ {#å†…éƒ¨å¯å¤‰æ€§ .View_chapterTitle__tslMs}

## [](#%F0%9F%93%8C-%E5%86%85%E9%83%A8%E5%8F%AF%E5%A4%89%E6%80%A7){.header-anchor-link} ğŸ“Œ å†…éƒ¨å¯å¤‰æ€§ {#%F0%9F%93%8C-%E5%86%85%E9%83%A8%E5%8F%AF%E5%A4%89%E6%80%A7}

Rust
ã«ã¯åˆ¶é™ä»˜ãã§ï¼Œä¸å¤‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å®‰å…¨ã«å¯å¤‰ã«ã™ã‚‹æ–¹æ³•ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ï¼ã“ã®å®Ÿè£…ã¯å†…éƒ¨å¯å¤‰æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆInterior
mutabilityï¼‰ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ï¼ã“ã“ã§ã¯ï¼Œè©³ã—ãèª¬æ˜ã—ã¾ã›ã‚“ãŒï¼Œå†…éƒ¨çš„ã«ã¯
`unsafe` ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼ã“ã®æ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯ `Cell`, `RefCell`
ã‚’ä½¿ã„ã¾ã™ï¼ã¾ãšã¯ï¼Œ `Rc` ã«ã¤ã„ã¦è€ƒãˆãªãŒã‚‰ `Cell`, `RefCell`
ã®ä½¿ã„æ–¹ã‚’è¦‹ã¦ã„ãã¾ã™ï¼

`Rc`
ã¯å†…éƒ¨ã§å‚ç…§ã—ã¦ã„ã‚‹æ•°ã‚’ä¿æŒã™ã‚‹ã“ã¨ã§æ‰€æœ‰æ¨©ã‚’å…±æœ‰ã—ã¦ã„ã¾ã™ï¼ãã®æ•°ã¯
`Rc::strong_count` ã§å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

::: code-block-container
``` language-rust
use std::rc::Rc;

fn main() {
    let a = Rc::new(10);        // shared reference to immutable object
    dbg!(Rc::strong_count(&a)); // Rc::strong_count(&a) = 1

    let b = Rc::clone(&a);      // cloned shared reference
    dbg!(Rc::strong_count(&a)); // Rc::strong_count(&a) = 2
    dbg!(Rc::strong_count(&b)); // Rc::strong_count(&b) = 2
}
```
:::

`Rc::clone`
ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ï¼Œå‚ç…§ã‚«ã‚¦ãƒ³ã‚¿ã®å€¤ãŒå¢—ãˆã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼ã“ã“ã§ï¼Œå¤‰æ•°
`a`
ã¯ä¸å¤‰ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšï¼Œå†…éƒ¨ã§ä¿æŒã—ã¦ã„ã‚‹å‚ç…§ã‚«ã‚¦ãƒ³ã‚¿ã®å€¤ãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼é€šå¸¸ã¯ä¸å¤‰æŸç¸›ã®å¤‰æ•°ã‹ã‚‰å¯å¤‰å‚ç…§ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ï¼
`Rc::clone`
ã¯ä¸å¤‰å‚ç…§ã‚’å¼•æ•°ã«å–ã£ã¦ã„ã‚‹ã®ã§ï¼Œå†…éƒ¨ã®å‚ç…§ã‚«ã‚¦ãƒ³ã‚¿ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ãªã„ã¯ãšã§ã™ï¼

::: code-block-container
``` language-rust
pub fn clone(&self) -> Self
```
:::

ãã“ã§ï¼Œå†…éƒ¨å¯å¤‰æ€§ã§ã™ï¼ä¸å¤‰ãƒ»å¯å¤‰ã®æ¤œæŸ»ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«è¡Œã‚ã‚Œã¾ã™ãŒï¼Œå†…éƒ¨å¯å¤‰æ€§ã‚’ä½¿ã†ã¨å®Ÿè¡Œæ™‚ï¼ˆãƒ©ãƒ³ã‚¿ã‚¤ãƒ æ™‚ï¼‰ã«è¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šï¼Œåˆ¶ç´„ãŒç·©ããªã‚Šã¾ã™ï¼ã¨ã¯ã„ãˆï¼Œå¥½ãå‹æ‰‹ã«å€¤ã‚’å¤‰ãˆã‚‰ã‚Œã¦ã¯å›°ã‚‹ã®ã§ï¼Œ
`Cell` ã‚„ `RefCell`
å‹ã«ãã®æ©Ÿèƒ½ã‚’ã¾ã¨ã‚ã¦æ­£å½“æ€§ã‚’ä¿ã¤ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼ã¡ãªã¿ã«å†…éƒ¨çš„ã«ã¯
`UnsafeCell` ã¨ã„ã†ã‚‚ã®ã‚’ä½¿ã£ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼\
`Cell` ã®ä½¿ã„æ–¹ã¯ `Cell::new` ã§ä½œæˆã—ï¼Œ `get`, `set` ã§æ“ä½œã—ã¾ã™ï¼

::: code-block-container
``` language-rust
use std::cell::Cell;

fn main() {
    let a = Cell::new(10); // immutable object with interior mutability
    dbg!(a.get()); // a.get() = 10
    a.set(20);
    dbg!(a.get()); // a.get() = 20
}
```
:::

`replace` ã¯å€¤ã‚’ç½®ãæ›ãˆã¦ï¼Œä»¥å‰ã®å€¤ã‚’è¿”ã—ã¾ã™ï¼ `into_inner`
ã¯å†…éƒ¨ã®å€¤ã‚’å–ã‚Šå‡ºã—ã¾ã™ï¼ï¼ˆ `T` å‹ã«å‹å¤‰æ›ã—ã¾ã™ï¼‰

::: code-block-container
``` language-rust
fn main() {
    let a = Cell::new(10); // immutable object with interior mutability
    let b = a.replace(20);
    dbg!(a.get()); // a.get() = 20
    dbg!(b);       // b = 10
    
    let c = a.into_inner(); // turn Cell<T> into T
    dbg!(c);       // c = 20
    dbg!(a);       // borrow check - Error
}
```
:::

ä¾‹ãˆã°ï¼Œ `Rc` ãŒå†…éƒ¨ã§ä¿æŒã—ã¦ã„ã‚‹å‚ç…§ã‚«ã‚¦ãƒ³ã‚¿ã‚’ `RefCount` ã¨ã—ãŸå ´åˆï¼Œ
`Rc<T> = &(Cell<RefCount>, T)` ã¨è€ƒãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ã¾ãŸï¼Œ `Rc`
ã§å…±æœ‰ã—ã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¯å¤‰ã«ã—ãŸã„å ´åˆï¼Œæ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã¯å‡ºæ¥ã¾ã›ã‚“ï¼

::: code-block-container
``` language-rust
fn main() {
    let mut a = Rc::new(10); // shared reference to immutable object
    *a = 20; // Error
}
```
:::

ã“ã®å ´åˆã¯ `Cell` ã‚’ä½¿ã„ã¾ã™ï¼

::: code-block-container
``` language-rust
fn main() {
    let a = Rc::new(Cell::new(10));
    a.set(20);
    dbg!(a.get()); // a.get() = 20

    let b = Rc::clone(&a);
    b.set(30);
    dbg!(a.get()); // a.get() = 30
}
```
:::

`Cell<T>` ã®å¤§ããªåˆ¶ç´„ã¨ã—ã¦ï¼Œ `T` ã¯ `Copy`
ãƒˆãƒ¬ã‚¤ãƒˆå¢ƒç•ŒãŒã‚ã‚‹ã“ã¨ã§ã™ï¼ã“ã®ãŸã‚ï¼Œå‚ç…§ç‰ˆã§ã‚ã‚‹ `RefCell<T>`
ãŒã‚ã‚Šã¾ã™ï¼ `RefCell` ã«ã¯ä¸å¤‰å‚ç…§ã‚’è¿”ã™ `borrow`, å¯å¤‰å‚ç…§ã‚’è¿”ã™
`borrow_mut` ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šï¼Œãã‚Œãã‚Œä¸å¤‰å‚ç…§ã§ã‚ã‚‹ `Ref`
å‹ï¼Œå¯å¤‰å‚ç…§ã§ã‚ã‚‹ `RefMut` å‹ã‚’è¿”ã—ã¾ã™ï¼

::: code-block-container
``` language-rust
pub fn borrow(&self) -> Ref<'_, T>;
pub fn borrow_mut(&self) -> RefMut<'_, T>;
```
:::

`Ref`, `RefMut` ã«ã¯ï¼Œé€šå¸¸ã®ä¸å¤‰å‚ç…§( `&` )ï¼Œå¯å¤‰å‚ç…§( `&mut`
)ã¨åŒã˜åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ï¼ãŸã ã—ï¼Œã“ã®å ´åˆã®å€Ÿç”¨ãƒã‚§ãƒƒã‚¯ã¯å®Ÿè¡Œæ™‚ã«è¡Œã‚ã‚Œï¼Œãã®æ™‚ã«åˆ¶ç´„ã‚’æº€ãŸã—ã¦ã„ãªã‘ã‚Œã°
`panic!` ãŒå‘¼ã°ã‚Œã¾ã™ï¼

::: code-block-container
``` language-rust
use std::{rc::Rc, cell::RefCell};

fn main() {
    let a = Rc::new(RefCell::new(String::from("hoge")));
    dbg!(a.borrow()); // a.borrow() = "hoge"
    
    *(a.borrow_mut()) = String::from("foo");
    dbg!(a.borrow()); // a.borrow() = "foo"
    
    let b = Rc::clone(&a);
    *(b.borrow_mut()) = String::from("bar");
    dbg!(a.borrow()); // a.borrow() = "bar"
    
    let c = a.borrow_mut();
    let d = a.borrow_mut(); // panic!
}
```
:::

`Ref`ï¼Œ `RefMut`
ã¯RAIIã®å®Ÿè£…ã«ãªã£ã¦ã„ã¦ï¼Œè¤‡æ•°ã®å¯å¤‰å‚ç…§ã‚„ä¸å¤‰ã¨å¯å¤‰å‚ç…§ãŒåŒæ™‚ã«å­˜åœ¨ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ãªã„ã‚ˆã†ã«æ¤œæŸ»ã—ã¦ã„ã¾ã™ï¼

ã“ã“ã¾ã§ï¼Œæ‰€æœ‰æ¨©ã‚’å…±æœ‰ã™ã‚‹ `Rc` ï¼Œå†…éƒ¨å¯å¤‰æ€§ã‚’æŒã¤ `Cell` ã¨ `RefCell`
ã‚’è¦‹ã¦ãã¾ã—ãŸï¼\
ã¾ãŸã¾ãŸï¼Œã“ã®å›³ã§ã™ï¼

![rust-onwership01](https://storage.googleapis.com/zenn-user-upload/ym0o15tj4kbs3tyrqqow30n9bp3h){.md-img
loading="lazy"}

`Rc`, `Cell`, `RefCell` ã‚’è¡¨ã™ã¨...

![rust-cell](https://storage.googleapis.com/zenn-user-upload/0j9x7co5ll9cs0xl1eztl55dq4qs){.md-img
loading="lazy"}
:::
:::
:::

